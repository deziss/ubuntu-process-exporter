# docker-compose.cgroup-v1.yml
# Alternative configuration for cgroup v1-only systems

services:
  ubuntu-process-exporter:
    build: .
    image: ubuntu-process-exporter:latest
    network_mode: host
    pid: host
    privileged: true
    read_only: true
    volumes:
      - /proc:/host/proc:ro
      # Cgroup v1 subsystems
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
      # Individual v1 mounts (explicit):
      - /sys/fs/cgroup/cpu:/sys/fs/cgroup/cpu:ro
      - /sys/fs/cgroup/memory:/sys/fs/cgroup/memory:ro
      - /sys/fs/cgroup/cpuacct:/sys/fs/cgroup/cpuacct:ro
      - /sys/fs/cgroup/cpuset:/sys/fs/cgroup/cpuset:ro
      - /sys/fs/cgroup/pids:/sys/fs/cgroup/pids:ro
      - /etc/hostname:/host/etc/hostname:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    tmpfs:
      - /tmp
      - /run

    environment:
      PROC_DIR: /host/proc
      METRICS_PORT: "9106"
      SCRAPE_TIMEOUT: "300"
      TOP_N: "25"
      ENABLE_DISK_IO: "true"
      # For cgroup v1 systems, you may need to enable docker socket
      # DOCKER_HOST: unix:///var/run/docker.sock

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:9106/health"]
      interval: 30s
      timeout: 5s
      retries: 3
